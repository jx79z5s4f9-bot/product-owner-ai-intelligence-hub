<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PO AI - Intelligence Hub</title>
  <link rel="stylesheet" href="/css/app.css">
  <link rel="stylesheet" href="/css/home.css">
</head>
<body>
  <%- include('partials/nav', { activePage: 'home' }) %>
  <%- include('partials/onboarding') %>

  <main class="home-container">
    <div class="home-header">
      <h1>üéØ Intelligence Hub</h1>
      <p>Your Product Ownership knowledge base</p>
    </div>
    
    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="stat">
        <div class="stat-value" id="docCount"><span class="ds-skeleton ds-skeleton-stat"></span></div>
        <div class="stat-label">Documents</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="actorCount"><span class="ds-skeleton ds-skeleton-stat"></span></div>
        <div class="stat-label">Actors</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="tagCount"><span class="ds-skeleton ds-skeleton-stat"></span></div>
        <div class="stat-label">Tags</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="pendingCount"><span class="ds-skeleton ds-skeleton-stat"></span></div>
        <div class="stat-label">Pending</div>
      </div>
    </div>

    <!-- Overdue alert banner -->
    <a id="overdueBanner" href="/register?status=overdue" class="overdue-banner" style="display:none;">
      <span class="overdue-pulse"></span>
      <span class="overdue-text">‚ö†Ô∏è <strong id="overdueCount">0</strong> overdue items need attention</span>
      <span class="overdue-arrow">‚Üí</span>
    </a>
    
    <!-- 
      TILE CONFIGURATION
      ===================
      To reorder tiles: Change data-order attribute (lower = first)
      To regroup tiles: Change data-group attribute
      To change color: Change data-color attribute
      
      Colors: green, blue, purple, orange, pink, teal, yellow, red, gray
      Groups: core, knowledge, system
    -->
    
    <!-- All tiles rendered from config -->
    <div id="tileContainer"></div>
    
    <!-- Dismissible donate banner -->
    <div id="donateBanner" class="donate-banner" style="display: none;">
      <button class="donate-close" onclick="dismissDonate()" aria-label="Close">&times;</button>
      <span class="donate-text">Like PO AI? Support development</span>
      <a href="https://etherscan.io/address/jurnan.base.eth" target="_blank" rel="noopener" class="donate-link">jurnan.base.eth</a>
    </div>

    <div class="keyboard-hint">
      <kbd>‚åòK</kbd> Command Palette ‚Ä¢ Click logo to return home
    </div>
  </main>

  <style>
    /* Overdue banner */
    .overdue-banner {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.25rem;
      margin-bottom: 1rem;
      background: rgba(248, 81, 73, 0.08);
      border: 1px solid rgba(248, 81, 73, 0.3);
      border-radius: 8px;
      color: #f85149;
      text-decoration: none;
      font-size: 0.9rem;
      transition: all 0.2s;
      cursor: pointer;
    }
    .overdue-banner:hover {
      background: rgba(248, 81, 73, 0.15);
      border-color: rgba(248, 81, 73, 0.5);
    }
    .overdue-pulse {
      width: 8px;
      height: 8px;
      background: #f85149;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.8); }
    }
    .overdue-text { flex: 1; color: #e6edf3; }
    .overdue-text strong { color: #f85149; }
    .overdue-arrow { color: #f85149; font-size: 1.1rem; }

    .donate-banner {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      padding: 0.6rem 1rem;
      margin-top: 1.5rem;
      background: rgba(139, 92, 246, 0.08);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 8px;
      font-size: 0.85rem;
      color: var(--text-muted, #9ca3af);
      position: relative;
    }
    .donate-text { opacity: 0.8; }
    .donate-link {
      color: #a78bfa;
      text-decoration: none;
      font-weight: 500;
      font-family: monospace;
      font-size: 0.82rem;
    }
    .donate-link:hover { text-decoration: underline; color: #c4b5fd; }
    .donate-close {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-muted, #666);
      font-size: 1.1rem;
      cursor: pointer;
      padding: 0 4px;
      line-height: 1;
    }
    .donate-close:hover { color: var(--text-primary, #fff); }
  </style>

  <script>
    // =============================================
    // TILE CONFIGURATION - Edit here to reorder!
    // =============================================
    const TILES = [
      // Core Actions
      { id: 'ingest', group: 'core', order: 1, color: 'green', icon: 'üì•', title: 'Ingest', desc: 'Capture notes, logs, decisions', href: '/ingest' },
      { id: 'ask', group: 'core', order: 2, color: 'blue', icon: '‚ùì', title: 'Ask', desc: 'Query with evidence-based answers', href: '/ask' },
      { id: 'search', group: 'core', order: 3, color: 'orange', icon: 'üîç', title: 'Search', desc: 'Find documents by tags & dates', href: '/search' },
      { id: 'trend', group: 'core', order: 4, color: 'purple', icon: 'üìà', title: 'Trends', desc: 'Analyze patterns over time', href: '/trend' },
      { id: 'analyze', group: 'core', order: 5, color: 'pink', icon: 'üìÑ', title: 'Deep Analysis', desc: 'Heavy doc processing (Dutch)', href: '/analyze' },
      { id: 'standup', group: 'core', order: 6, color: 'yellow', icon: '‚òÄÔ∏è', title: 'Standup', desc: 'Daily activity summary', href: '/standup' },
      
      // Knowledge Tools
      { id: 'navigator', group: 'knowledge', order: 10, color: 'teal', icon: 'üóÇÔ∏è', title: 'Navigator', desc: 'Browse all documents', href: '/navigator' },
      { id: 'network', group: 'knowledge', order: 11, color: 'blue', icon: 'üï∏Ô∏è', title: 'Network', desc: 'Relationship graph', href: '/network' },
      { id: 'tags', group: 'knowledge', order: 12, color: 'yellow', icon: 'üè∑Ô∏è', title: 'Tags', desc: 'Manage categories', href: '/tags' },
      { id: 'register', group: 'knowledge', order: 13, color: 'red', icon: 'üìã', title: 'Register', desc: 'Risk & action tracking', href: '/register' },
      { id: 'stakeholders', group: 'knowledge', order: 15, color: 'orange', icon: 'üë•', title: 'Stakeholders', desc: 'People profiles & notes', href: '/stakeholders' },
      { id: 'suggestions', group: 'knowledge', order: 16, color: 'orange', icon: 'üß™', title: 'Suggestions', desc: 'Review relationships', href: '/suggestions' },
      // System
      { id: 'translate', group: 'system', order: 20, color: 'gray', icon: 'üåê', title: 'Translate', desc: 'Dutch ‚Üî English', href: '/translate' },
      { id: 'settings', group: 'system', order: 21, color: 'gray', icon: '‚öôÔ∏è', title: 'Settings', desc: 'LLM & config', href: '/settings' },
      { id: 'maintenance', group: 'system', order: 22, color: 'gray', icon: 'üîß', title: 'Maintenance', desc: 'System health', href: '/maintenance' },
      { id: 'guide', group: 'system', order: 23, color: 'teal', icon: 'üó∫Ô∏è', title: 'Guide', desc: 'Interactive feature tour', href: '/guide' },
    ];
    
    const GROUP_LABELS = {
      'core': 'üìå Core Actions',
      'knowledge': 'üß† Knowledge Tools',
      'system': '‚öôÔ∏è System'
    };
    
    // =============================================
    // Render tiles grouped and sorted
    // =============================================
    function renderTiles() {
      const container = document.getElementById('tileContainer');
      
      // Group tiles
      const groups = {};
      TILES.forEach(tile => {
        if (!groups[tile.group]) groups[tile.group] = [];
        groups[tile.group].push(tile);
      });
      
      // Sort each group by order
      Object.keys(groups).forEach(group => {
        groups[group].sort((a, b) => a.order - b.order);
      });
      
      // Render in group order
      const groupOrder = ['core', 'knowledge', 'system'];
      let html = '';
      
      groupOrder.forEach(groupKey => {
        if (!groups[groupKey]) return;
        
        html += `
          <div class="tile-section">
            <div class="section-label">${GROUP_LABELS[groupKey] || groupKey}</div>
            <div class="tile-grid">
              ${groups[groupKey].map(tile => `
                <a href="${tile.href}" class="tile" data-color="${tile.color}" data-id="${tile.id}">
                  <div class="tile-icon">${tile.icon}</div>
                  <div class="tile-title">${tile.title}</div>
                  <div class="tile-desc">${tile.desc}</div>
                </a>
              `).join('')}
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    // Load stats
    async function loadStats() {
      try {
        const res = await fetch('/api/settings/status');
        const status = await res.json();

        // Replace skeletons with actual values
        POAI.skeleton.replace('#docCount', status.database?.documents || 0);
        POAI.skeleton.replace('#actorCount', status.database?.actors || 0);
        POAI.skeleton.replace('#tagCount', status.database?.tags || 0);
        POAI.skeleton.replace('#pendingCount', status.extraction?.stats?.pending || 0);
      } catch (err) {
        console.error('Failed to load stats:', err);
        // Show error state
        POAI.skeleton.replace('#docCount', '--');
        POAI.skeleton.replace('#actorCount', '--');
        POAI.skeleton.replace('#tagCount', '--');
        POAI.skeleton.replace('#pendingCount', '--');
      }
    }
    
    // Donate banner ‚Äî dismissible, resets on new version
    const DONATE_VERSION = '1.1.0';
    function checkDonateBanner() {
      const dismissed = localStorage.getItem('donate_dismissed');
      if (dismissed !== DONATE_VERSION) {
        const banner = document.getElementById('donateBanner');
        if (banner) banner.style.display = 'flex';
      }
    }
    function dismissDonate() {
      localStorage.setItem('donate_dismissed', DONATE_VERSION);
      const banner = document.getElementById('donateBanner');
      if (banner) banner.style.display = 'none';
    }

    // Load overdue count from register
    async function loadOverdue() {
      try {
        const res = await fetch('/api/register/stats');
        const stats = await res.json();
        const overdue = stats.overdue || 0;
        if (overdue > 0) {
          document.getElementById('overdueCount').textContent = overdue;
          document.getElementById('overdueBanner').style.display = 'flex';
        }
      } catch (err) {
        console.error('Failed to load overdue stats:', err);
      }
    }

    // Initialize
    renderTiles();
    loadStats();
    loadOverdue();
    checkDonateBanner();
  </script>
</body>
</html>
