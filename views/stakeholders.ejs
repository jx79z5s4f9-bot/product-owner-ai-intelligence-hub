<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stakeholders - PO AI</title>
  <link rel="stylesheet" href="/css/app.css">
  <style>
    .stakeholders-container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
    }

    .stakeholders-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .stakeholders-header h1 {
      font-size: 1.8rem;
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 0;
    }

    .header-stats {
      display: flex;
      gap: 16px;
      font-size: 0.9rem;
      color: #8b949e;
    }

    .header-stats strong { color: #e6edf3; }

    /* Controls */
    .controls-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-input {
      flex: 1;
      min-width: 200px;
      padding: 10px 14px;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      color: #c9d1d9;
      font-size: 0.95rem;
    }

    .search-input:focus {
      outline: none;
      border-color: #58a6ff;
    }

    .filter-btn {
      padding: 8px 16px;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 8px;
      color: #8b949e;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.15s;
    }

    .filter-btn:hover { background: #30363d; color: #c9d1d9; }
    .filter-btn.active {
      background: #388bfd26;
      border-color: #58a6ff;
      color: #58a6ff;
    }

    .rte-select {
      padding: 8px 12px;
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 8px;
      color: #c9d1d9;
      font-size: 0.9rem;
    }

    /* Grid of cards */
    .person-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }

    .person-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 10px;
      padding: 16px;
      cursor: pointer;
      transition: border-color 0.15s, transform 0.15s;
      text-decoration: none;
      color: inherit;
      display: block;
    }

    .person-card:hover {
      border-color: #58a6ff;
      transform: translateY(-2px);
    }

    .person-card.is-stakeholder {
      border-left: 3px solid #f0883e;
    }

    .card-top {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 10px;
    }

    .card-avatar {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: #30363d;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      flex-shrink: 0;
      color: #e6edf3;
    }

    .card-avatar.stakeholder { background: #f0883e; }

    .card-info { flex: 1; min-width: 0; }

    .card-name {
      font-size: 1.05rem;
      font-weight: 600;
      color: #e6edf3;
      margin-bottom: 2px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .card-role {
      font-size: 0.8rem;
      color: #8b949e;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .card-badges {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .card-badge {
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 600;
      background: #21262d;
      color: #8b949e;
    }

    .card-badge.team { background: #1f6feb26; color: #58a6ff; }
    .card-badge.org { background: #23863626; color: #3fb950; }
    .card-badge.stakeholder { background: #f0883e26; color: #f0883e; }

    .card-stats {
      display: flex;
      gap: 16px;
      font-size: 0.8rem;
      color: #484f58;
      border-top: 1px solid #21262d;
      padding-top: 8px;
    }

    .card-stats span { display: flex; align-items: center; gap: 4px; }

    /* Empty */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #484f58;
    }

    .empty-state .empty-icon { font-size: 3rem; margin-bottom: 12px; }
    .empty-state h2 { color: #8b949e; margin-bottom: 8px; }

    /* Loading */
    .loading-overlay {
      text-align: center;
      padding: 60px;
      color: #8b949e;
    }

    .spinner-large {
      display: inline-block;
      width: 32px;
      height: 32px;
      border: 3px solid #30363d;
      border-top-color: #58a6ff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 12px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 640px) {
      .person-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <%- include('partials/nav', { activePage: 'stakeholders' }) %>

  <main class="stakeholders-container">
    <div class="stakeholders-header">
      <h1>üë• Stakeholders</h1>
      <div class="header-stats">
        <span><strong id="visibleCount">‚Äì</strong> shown</span>
        <span><strong id="stakeholderCount">‚Äì</strong> ‚≠ê stakeholders</span>
        <span id="hiddenNotice" style="display:none; font-size:0.8rem; color:#484f58;"></span>
      </div>
    </div>

    <div class="controls-bar">
      <input type="text" class="search-input" id="searchInput"
             placeholder="Search by name‚Ä¶" autocomplete="off">
      <button class="filter-btn" id="filterAll" onclick="setFilter('')">Relevant</button>
      <button class="filter-btn" id="filterStakeholders" onclick="setFilter('stakeholders')">‚≠ê Stakeholders</button>
      <button class="filter-btn" id="filterShowAll" onclick="setFilter('all')">All People</button>
      <select class="rte-select" id="rteFilter">
        <option value="">All RTEs</option>
      </select>
    </div>

    <div id="personGrid">
      <div class="loading-overlay">
        <div class="spinner-large"></div>
        <div>Loading people‚Ä¶</div>
      </div>
    </div>
  </main>

  <script>
    let currentFilter = '';
    let searchTimeout = null;

    // Init
    (async function init() {
      await loadRTEs();
      await loadPeople();

      document.getElementById('searchInput').addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(loadPeople, 300);
      });

      document.getElementById('rteFilter').addEventListener('change', loadPeople);
    })();

    async function loadRTEs() {
      try {
        const res = await fetch('/api/rtes');
        const data = await res.json();
        const select = document.getElementById('rteFilter');
        const defaultRte = localStorage.getItem('poai_default_rte');
        data.rtes.forEach(rte => {
          const opt = document.createElement('option');
          opt.value = rte.id;
          opt.textContent = rte.name;
          if (defaultRte && defaultRte == rte.id) opt.selected = true;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error('Failed to load RTEs:', err);
      }
    }

    function setFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      if (filter === 'stakeholders') {
        document.getElementById('filterStakeholders').classList.add('active');
      } else if (filter === 'all') {
        document.getElementById('filterShowAll').classList.add('active');
      } else {
        document.getElementById('filterAll').classList.add('active');
      }
      loadPeople();
    }

    async function loadPeople() {
      const container = document.getElementById('personGrid');
      const search = document.getElementById('searchInput').value.trim();
      const rteId = document.getElementById('rteFilter').value;

      const params = new URLSearchParams();
      if (search) params.append('search', search);
      if (rteId) params.append('rteId', rteId);
      if (currentFilter === 'stakeholders') params.append('stakeholdersOnly', '1');
      if (currentFilter === 'all') params.append('showAll', '1');

      try {
        const res = await fetch(`/api/stakeholders?${params}`);
        const data = await res.json();

        document.getElementById('visibleCount').textContent = data.actors.length;
        document.getElementById('stakeholderCount').textContent = data.stakeholders;

        // Show hidden count notice
        const hiddenNotice = document.getElementById('hiddenNotice');
        if (currentFilter !== 'all' && currentFilter !== 'stakeholders') {
          const hidden = data.total - data.withDocs;
          if (hidden > 0) {
            hiddenNotice.style.display = 'inline';
            hiddenNotice.textContent = `(${hidden} low-relevance actors hidden)`;
          } else {
            hiddenNotice.style.display = 'none';
          }
        } else {
          hiddenNotice.style.display = 'none';
        }

        if (data.actors.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üîç</div>
              <h2>No people found</h2>
              <p>Try adjusting your search or filters.</p>
            </div>
          `;
          return;
        }

        container.innerHTML = `<div class="person-grid">${data.actors.map(renderCard).join('')}</div>`;

      } catch (err) {
        container.innerHTML = `<div class="empty-state"><p>Failed to load: ${err.message}</p></div>`;
      }
    }

    function renderCard(actor) {
      const initial = actor.name.charAt(0).toUpperCase();
      const avatarClass = actor.is_stakeholder ? 'card-avatar stakeholder' : 'card-avatar';
      const cardClass = actor.is_stakeholder ? 'person-card is-stakeholder' : 'person-card';

      const roleParts = [actor.role, actor.team, actor.organization].filter(Boolean);
      const roleStr = roleParts.join(' ¬∑ ');

      let badges = '';
      if (actor.is_stakeholder) badges += '<span class="card-badge stakeholder">‚≠ê Stakeholder</span>';
      if (actor.team) badges += `<span class="card-badge team">${escapeHtml(actor.team)}</span>`;
      if (actor.organization) badges += `<span class="card-badge org">${escapeHtml(actor.organization)}</span>`;

      return `
        <a href="/stakeholder/${actor.id}" class="${cardClass}">
          <div class="card-top">
            <div class="${avatarClass}">${initial}</div>
            <div class="card-info">
              <div class="card-name">${escapeHtml(actor.name)}</div>
              ${roleStr ? `<div class="card-role">${escapeHtml(roleStr)}</div>` : ''}
            </div>
          </div>
          ${badges ? `<div class="card-badges">${badges}</div>` : ''}
          <div class="card-stats">
            <span>üìÑ ${actor.document_count || 0} docs</span>
            <span>üí¨ ${actor.mention_count || 0} mentions</span>
            ${actor.last_seen_at ? `<span>üïê ${actor.last_seen_at.split('T')[0]}</span>` : ''}
          </div>
        </a>
      `;
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    // Activate the correct filter button
    setFilter('');
  </script>
</body>
</html>
